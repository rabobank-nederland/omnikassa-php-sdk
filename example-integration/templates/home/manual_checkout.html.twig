{% extends 'base.html.twig' %}

{% block title %}Manual Checkout - OmniKassa SDK{% endblock %}

{% block stylesheets %}{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemIndex = 2; // Start from 2 since we have 2 default items

    // Function to calculate item total
    function calculateItemTotal(row) {
        const quantity = parseFloat(row.querySelector('input[name*="[quantity]"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('input[name*="[unitPrice]"]').value) || 0;
        const total = quantity * unitPrice;
        row.querySelector('.item-total').textContent = '€ ' + total.toFixed(2);
        return total;
    }

    // Function to calculate grand total
    function calculateGrandTotal() {
        let subtotal = 0;
        document.querySelectorAll('.cart-item').forEach(row => {
            subtotal += calculateItemTotal(row);
        });

        const shippingCost = parseFloat(document.getElementById('shipping-cost').value) || 0;
        const total = subtotal + shippingCost;

        document.getElementById('subtotal').textContent = '€ ' + subtotal.toFixed(2);
        document.getElementById('shipping-display').textContent = '€ ' + shippingCost.toFixed(2);
        document.getElementById('total-amount').textContent = '€ ' + total.toFixed(2);
    }

    // Add event listeners to existing inputs
    document.querySelectorAll('input[name*="[quantity]"], input[name*="[unitPrice]"]').forEach(input => {
        input.addEventListener('input', calculateGrandTotal);
    });

    // Add event listener for shipping cost
    document.getElementById('shipping-cost').addEventListener('input', calculateGrandTotal);

    // Add item button
    document.getElementById('add-item-btn').addEventListener('click', function() {
        const tbody = document.getElementById('cart-items');
        const subtotalRow = document.getElementById('subtotal-row');
        const newRow = document.createElement('tr');
        newRow.className = 'cart-item';
        newRow.innerHTML = `
            <td>
                <input type="text" name="items[${itemIndex}][name]" placeholder="Item name" required style="width: 100%; border: none; background: transparent;">
                <br><input type="text" name="items[${itemIndex}][description]" placeholder="Description" style="width: 100%; border: none; background: transparent; font-size: 0.9em; color: #6c757d;">
            </td>
            <td><input type="number" name="items[${itemIndex}][quantity]" value="1" min="1" required style="width: 60px; text-align: center;"></td>
            <td><input type="number" name="items[${itemIndex}][unitPrice]" value="0.00" step="0.01" min="0" required style="width: 80px; text-align: right;"></td>
            <td>
                <select name="items[${itemIndex}][taxCategory]" style="width: 100px;">
                    <option value="tools" selected>tools</option>
                    <option value="electronics">electronics</option>
                    <option value="books">books</option>
                    <option value="food">food</option>
                </select>
            </td>
            <td class="price item-total">€ 0.00</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
        `;
        tbody.insertBefore(newRow, subtotalRow);
        itemIndex++;

        // Add event listeners to new inputs
        newRow.querySelectorAll('input[name*="[quantity]"], input[name*="[unitPrice]"]').forEach(input => {
            input.addEventListener('input', calculateGrandTotal);
        });

        calculateGrandTotal();
    });

    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            e.target.closest('.cart-item').remove();
            calculateGrandTotal();
        }
    });

    // Initial calculation
    calculateGrandTotal();

    // Shipping address toggle functionality
    const useCustomerAsShippingCheckbox = document.getElementById('useCustomerAsShipping');
    const shippingAddressFields = document.getElementById('shippingAddressFields');

    function toggleShippingFields() {
        if (useCustomerAsShippingCheckbox.checked) {
            shippingAddressFields.style.display = 'none';
            // Clear shipping address fields when using customer info
            document.querySelectorAll('#shippingAddressFields input').forEach(input => {
                input.required = false;
                input.value = '';
            });
        } else {
            shippingAddressFields.style.display = 'block';
            // Make shipping address fields required when not using customer info
            document.querySelectorAll('#shippingAddressFields input').forEach(input => {
                input.required = true;
            });
        }
    }

    useCustomerAsShippingCheckbox.addEventListener('change', toggleShippingFields);

    // Initial state
    toggleShippingFields();
});
</script>
{% endblock %}

{% block body %}
<div class="checkout-container">
    <div class="checkout-header">
        <h1>Manual Checkout</h1>
        <p>Fill in your customer and shipping details to proceed with the checkout</p>
    </div>

    <form method="post" id="checkout-form">
        <div class="cart-section">
            <h2>Shopping Cart</h2>
            <div style="margin-bottom: 1em;">
                <button type="button" class="btn btn-secondary" id="add-item-btn">Add Item</button>
            </div>
            <table class="cart-table" id="cart-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Unit Price (€)</th>
                        <th>Tax Category</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cart-items">
                    <tr class="cart-item">
                        <td>
                            <input type="text" name="items[0][name]" value="Product X" required style="width: 100%; border: none; background: transparent;">
                            <br><input type="text" name="items[0][description]" value="A useful product" placeholder="Description" style="width: 100%; border: none; background: transparent; font-size: 0.9em; color: #6c757d;">
                        </td>
                        <td><input type="number" name="items[0][quantity]" value="2" min="1" required style="width: 60px; text-align: center;"></td>
                        <td><input type="number" name="items[0][unitPrice]" value="19.99" step="0.01" min="0" required style="width: 80px; text-align: right;"></td>
                        <td>
                            <select name="items[0][taxCategory]" style="width: 100px;">
                                <option value="tools" selected>tools</option>
                                <option value="electronics">electronics</option>
                                <option value="books">books</option>
                                <option value="food">food</option>
                            </select>
                        </td>
                        <td class="price item-total">&euro; 39.98</td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
                    </tr>
                    <tr class="cart-item">
                        <td>
                            <input type="text" name="items[1][name]" value="Gadget" required style="width: 100%; border: none; background: transparent;">
                            <br><input type="text" name="items[1][description]" value="A fancy gadget" placeholder="Description" style="width: 100%; border: none; background: transparent; font-size: 0.9em; color: #6c757d;">
                        </td>
                        <td><input type="number" name="items[1][quantity]" value="1" min="1" required style="width: 60px; text-align: center;"></td>
                        <td><input type="number" name="items[1][unitPrice]" value="29.99" step="0.01" min="0" required style="width: 80px; text-align: right;"></td>
                        <td>
                            <select name="items[1][taxCategory]" style="width: 100px;">
                                <option value="tools">tools</option>
                                <option value="electronics" selected>electronics</option>
                                <option value="books">books</option>
                                <option value="food">food</option>
                            </select>
                        </td>
                        <td class="price item-total">&euro; 29.99</td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
                    </tr>
                    <tr id="subtotal-row" style="border-top: 2px solid #dee2e6; background-color: #f8f9fa;">
                        <td colspan="4" style="text-align: right; font-weight: bold; padding: 1em;">Subtotal</td>
                        <td class="price" style="font-weight: bold;" id="subtotal">&euro; 69.97</td>
                        <td></td>
                    </tr>
                    <tr style="background-color: #f8f9fa;">
                        <td colspan="4" style="text-align: right; padding: 1em;">
                            <label for="shipping-cost" style="font-weight: bold; margin-right: 0.5em;">Shipping Cost:</label>
                            <input type="number" id="shipping-cost" name="shippingCost" value="1.00" step="0.01" min="0" style="width: 80px; text-align: right; border: 1px solid #ced4da; border-radius: 0.25em; padding: 0.25em;">
                            €
                        </td>
                        <td class="price" id="shipping-display">&euro; 1.00</td>
                        <td></td>
                    </tr>
                    <tr style="border-top: 2px solid #dee2e6; background-color: #e9ecef;">
                        <td colspan="4" style="text-align: right; font-weight: bold; padding: 1em;">Total Amount</td>
                        <td class="price" style="font-weight: bold; font-size: 1.1em;" id="total-amount">&euro; 70.97</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="customer-section">
            <div class="info-section">
                <h2>Customer Information</h2>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="dateOfBirth">Date of Birth (dd-mm-YYYY)</label>
                    <input type="text" id="dateOfBirth" name="dateOfBirth" class="form-control" placeholder="01-01-1980" required>
                </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender" class="form-control" required>
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="initials">Initials</label>
                    <input type="text" id="initials" name="initials" class="form-control" required>
                </div>
            </div>
        </div>

        <div class="shipping-section">
            <div class="info-section">
                <h2>Shipping Address</h2>
                <div class="form-group">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="useCustomerAsShipping" name="useCustomerAsShipping" checked style="margin-right: 0.5em;">
                        Use customer information as shipping address
                    </label>
                </div>
                <div id="shippingAddressFields">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="middleName">Middle Name</label>
                        <input type="text" id="middleName" name="middleName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="street">Street</label>
                        <input type="text" id="street" name="street" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="houseNumber">House Number</label>
                        <input type="text" id="houseNumber" name="houseNumber" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="countryCode">Country Code</label>
                        <input type="text" id="countryCode" name="countryCode" class="form-control" value="NL" required>
                    </div>
                </div>
            </div>
        </div>

        {% if paymentBrands is defined and paymentBrands %}
        <div class="payment-section" style="margin-bottom: 3em; text-align: center;">
            <div class="info-section" style="display: inline-block; text-align: left; max-width: 400px;">
                <h2>Payment Method</h2>
                <div style="margin-bottom: 1em;">
                    <label for="paymentBrand" style="display: block; font-weight: 600; margin-bottom: 0.5em;">Select Payment Brand:</label>
                    <select name="paymentBrand" id="paymentBrand" style="padding: 0.5em; border: 1px solid #ced4da; border-radius: 0.25em; width: 100%; background-color: white;">
                        <option value="">-- Select Payment Brand (optional) --</option>
                        {% for brand in paymentBrands %}
                            <option value="{{ brand.getId() }}" {% if selectedPaymentBrand == brand.getId() %}selected{% endif %}>{{ brand.getName() }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="actions">
            <button class="btn btn-primary" type="button" onclick="window.history.back()">← Back</button>
            <button class="btn btn-success" type="submit">Proceed to Checkout</button>
        </div>
    </form>
</div>
{% endblock %}
